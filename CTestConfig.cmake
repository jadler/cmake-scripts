SET (PROJECT_TEST_NAME ${PROJECT_NAME}Test)

ADD_EXECUTABLE (${PROJECT_TEST_NAME})
ADD_DEPENDENCIES (${PROJECT_TEST_NAME} ${PROJECT_NAME})

ADD_CUSTOM_COMMAND (TARGET ${PROJECT_TEST_NAME}
	POST_BUILD
	COMMAND ${CMAKE_CTEST_COMMAND} -C $<CONFIGURATION> --output-on-failure
	COMMENT "Runing tests for ${PROJECT_TEST_NAME}"
	WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR})

FILE (GLOB _SOURCES
	"${CMAKE_CURRENT_SOURCE_DIR}/test/src/*.c*")
FILE (GLOB_RECURSE _PLATFORM_SPECIFIC_SOURCES
	"${CMAKE_CURRENT_SOURCE_DIR}/test/src/${CMAKE_SYSTEM_NAME}/*.c*")
TARGET_SOURCES (${PROJECT_TEST_NAME} PRIVATE ${_SOURCES} ${_PLATFORM_SPECIFIC_SOURCES})

FIND_PACKAGE (GTest REQUIRED)

TARGET_LINK_LIBRARIES (${PROJECT_TEST_NAME}
	PRIVATE
		${GTEST_BOTH_LIBRARIES}
		${PROJECT_NAME})

LINK_DIRECTORIES (${CMAKE_BINARY_DIR})
TARGET_INCLUDE_DIRECTORIES (${PROJECT_TEST_NAME}
	PRIVATE
		${CMAKE_CURRENT_SOURCE_DIR}/include
		${CMAKE_CURRENT_SOURCE_DIR}/src
		${CMAKE_CURRENT_SOURCE_DIR}/test/include
		${CMAKE_CURRENT_SOURCE_DIR}/test/src
		${GTEST_INCLUDE_DIRS})

IF (EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/test/resources")
	FILE (COPY "${CMAKE_CURRENT_SOURCE_DIR}/test/resources" DESTINATION "${CMAKE_CURRENT_BINARY_DIR}")
ENDIF ()

ENABLE_TESTING ()
INCLUDE (CTest)
INCLUDE (GoogleTest)
GTEST_ADD_TESTS (TARGET ${PROJECT_TEST_NAME})
